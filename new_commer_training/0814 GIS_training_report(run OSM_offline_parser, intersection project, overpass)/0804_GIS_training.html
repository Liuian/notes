<!DOCTYPE html>
<html>
<head>
<title>0804_GIS_training.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="osmofflineparser---singpore-water">OSM_offline_parser - singpore water</h1>
<h2 id="tutorial-processing-osm-data-with-python-scripts">Tutorial: Processing OSM Data with Python Scripts</h2>
<h3 id="steps">Steps:</h3>
<h3 id="1-download-the-required-pbf-file">1. Download the Required <code>.pbf</code> File</h3>
<ul>
<li>Visit <a href="https://download.geofabrik.de/">Geofabrik's download site</a>.</li>
<li>Navigate to the region you need and download the <code>.osm.pbf</code> file.</li>
</ul>
<h3 id="2-run-the-osm-offline-parser">2. Run the OSM Offline Parser</h3>
<ul>
<li>After downloading, run the following command to process the <code>.osm.pbf</code> file. Replace the file path with the location of your downloaded file:</li>
</ul>
<pre class="hljs"><code><div>Example:
python osm_offline_parser.py ./data/input/malaysia-singapore-brunei-latest.osm.pbf 525 1
</div></code></pre>
<pre class="hljs"><code><div>usage: osm_offline_parser.py [input] [mcc] [hofn_type]

positional arguments:
  input                 Input osm.pbf file path.
  mcc                   mcc
  hofn_type             Process hofn <span class="hljs-built_in">type</span>, Output file name
</div></code></pre>
<ul>
<li><strong>Output</strong>: This will generate a <code>water.tsv</code> file.</li>
</ul>
<h3 id="3-locate-the-output-watertsv-file">3. Locate the Output <code>water.tsv</code> File</h3>
<ul>
<li>The output file will be saved in the following path:</li>
</ul>
<pre class="hljs"><code><div>/home/covmo/test_Ian/osm_offline_parser/data/output/Singapore/water/[<span class="hljs-string">'536780'</span>]/post_processed/water.tsv
</div></code></pre>
<p><img src="./image-18.png" alt="alt text"></p>
<h3 id="4-manually-move-the-watertsv-file">4. Manually Move the <code>water.tsv</code> File</h3>
<ul>
<li>Move the <code>water.tsv</code> file from the <code>post_processed</code> directory to a new location as follows:</li>
</ul>
<pre class="hljs"><code><div>mv /home/covmo/test_Ian/osm_offline_parser/data/output/Singapore/water/[<span class="hljs-string">'536780'</span>]/post_processed/water.tsv /home/covmo/test_Ian/osm_offline_parser/data/output/Singapore/water/
</div></code></pre>
<p><img src="./image-1.png" alt="alt text"></p>
<h3 id="5-run-the-geo-polygon-generator">5. Run the Geo Polygon Generator</h3>
<ul>
<li>After moving the <code>water.tsv</code> file, execute the following command to generate the polygon files:</li>
</ul>
<pre class="hljs"><code><div>Example:
python geo_polygon_generator.py 525 1
</div></code></pre>
<pre class="hljs"><code><div>usage: geo_polygon_generator.py [-h] mcc hofn_types

positional arguments:
  mcc         mcc
  hofn_types  format: <span class="hljs-string">'HofnType1 HofnType2'</span> ...
</div></code></pre>
<ul>
<li><strong>Output</strong>: This will generate two files: <code>NT2_GEO_POLYGON.tsv</code> and <code>NT2_GEO_POLYGON.csv</code>.</li>
</ul>
<h3 id="6-locate-the-generated-files">6. Locate the Generated Files</h3>
<ul>
<li>The files will be saved in the following paths:</li>
</ul>
<pre class="hljs"><code><div>/home/covmo/test_Ian/osm_offline_parser/data/output/Singapore/NT2_GEO_POLYGON.tsv
</div></code></pre>
<pre class="hljs"><code><div>/home/covmo/test_Ian/osm_offline_parser/data/output/Singapore/NT2_GEO_POLYGON.csv
</div></code></pre>
<p><img src="./image-2.png" alt="alt text"><img src="./image-3.png" alt="alt text"></p>
<ul>
<li>output visulization
<img src="./image-4.png" alt="alt text"></li>
</ul>
<h1 id="project2---intersection">Project2 - intersection</h1>
<h2 id="objective-calculate-the-land-area-within-each-grid-and-determine-how-many-counties-and-cities-it-contains">Objective: Calculate the land area within each grid and determine how many counties and cities it contains.</h2>
<ul>
<li>input: county.geojson, self_grid.geojson
<ul>
<li><img src="./image-9.png" alt="alt text"></li>
<li><img src="./image-13.png" alt="alt text"> <img src="./image-12.png" alt="alt text"></li>
</ul>
</li>
<li>output: output_pyproj_geojson
<ul>
<li><img src="./image-15.png" alt="alt text"></li>
<li><img src="./image-14.png" alt="alt text"></li>
</ul>
</li>
</ul>
<h2 id="problem-different-methods-of-calculating-the-area-yield-different-results">Problem: Different methods of calculating the area yield different results.</h2>
<h3 id="my-method-pyproj">my method: pyproj</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">from</span> pyproj <span class="hljs-keyword">import</span> Geod

geod = Geod(ellps=<span class="hljs-string">"WGS84"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_area</span><span class="hljs-params">(geom)</span>:</span>
    <span class="hljs-keyword">return</span> abs(geod.geometry_area_perimeter(geom)[<span class="hljs-number">0</span>])

intersections[<span class="hljs-string">'area'</span>] = intersections[<span class="hljs-string">'geometry'</span>].apply(calculate_area)
</div></code></pre>
<h3 id="difference">difference</h3>
<ul>
<li>The farther the longitude is from the center, the smaller the area; conversely, the closer to the center, the larger the area.</li>
<li>The farther the latitude is from the center, the smaller the area; conversely, the closer to the center, the larger the area.</li>
<li>The differences are generally between -0.2% and 0.2%.</li>
<li>The F6 region has a particularly large difference of 12.43%.
<img src="./image-5.png" alt="alt text"></li>
</ul>
<h2 id="procedure-processing-geojson-files-and-calculating-intersection-areas">Procedure: Processing GeoJSON Files and Calculating Intersection Areas</h2>
<p>This guide outlines the steps to read GeoJSON files, handle geometries, compute intersections, and calculate areas using Python's GeoPandas and PyProj libraries.</p>
<h3 id="step-1-read-geojson-files-into-geodataframe">Step 1: Read GeoJSON Files into GeoDataFrame</h3>
<ul>
<li>Import the necessary libraries and read the <code>GeoJSON</code> files into <code>GeoDataFrame</code> objects.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> geopandas <span class="hljs-keyword">as</span> gpd
<span class="hljs-keyword">from</span> pyproj <span class="hljs-keyword">import</span> Geod

counties = gpd.read_file(<span class="hljs-string">'county.geojson'</span>)
grid = gpd.read_file(<span class="hljs-string">'self_grid.geojson'</span>)
</div></code></pre>
<h3 id="step-2-check-for-invalid-geometries-and-remove-null-geometries">Step 2: Check for Invalid Geometries and Remove Null Geometries</h3>
<ul>
<li>Identify any invalid geometries in the datasets and remove rows with <code>None</code> geometries.</li>
</ul>
<pre class="hljs"><code><div>invalid_counties = counties[~counties.is_valid]
print(invalid_counties)
invalid_grids = grid[~grid.is_valid]
print(invalid_grids)

counties = counties[counties[<span class="hljs-string">'geometry'</span>].notnull()]
</div></code></pre>
<h3 id="step-3-explode-multipolygons-into-single-polygons">Step 3: Explode MultiPolygons into Single Polygons</h3>
<ul>
<li>Convert any <code>MultiPolygon</code> geometries into individual <code>Polygon</code> geometries.</li>
</ul>
<pre class="hljs"><code><div>counties = counties.explode().reset_index(drop=<span class="hljs-literal">True</span>)
</div></code></pre>
<h3 id="step-4-optional-verify-coordinate-reference-systems">Step 4: (Optional) Verify Coordinate Reference Systems</h3>
<ul>
<li>Check the Coordinate Reference System (CRS) of the GeoDataFrames to ensure they are in <code>EPSG:4326</code>.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-comment"># print(grid.crs)</span>
<span class="hljs-comment"># print(counties.crs)</span>
</div></code></pre>
<h3 id="step-5-calculate-intersections-between-grid-and-counties">Step 5: Calculate Intersections Between Grid and Counties</h3>
<ul>
<li>Perform a spatial intersection between the <code>grid</code> and <code>counties</code> to find overlapping areas.</li>
</ul>
<pre class="hljs"><code><div>intersections = gpd.overlay(grid, counties, how=<span class="hljs-string">'intersection'</span>)
</div></code></pre>
<h3 id="step-6-calculate-the-area-of-intersecting-geometries">Step 6: Calculate the Area of Intersecting Geometries</h3>
<ul>
<li>Use <code>pyproj.Geod</code> to calculate the area of each intersecting geometry. The area is returned in square meters.</li>
</ul>
<pre class="hljs"><code><div>geod = Geod(ellps=<span class="hljs-string">"WGS84"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_area</span><span class="hljs-params">(geom)</span>:</span>
    <span class="hljs-keyword">return</span> abs(geod.geometry_area_perimeter(geom)[<span class="hljs-number">0</span>])

intersections[<span class="hljs-string">'area'</span>] = intersections[<span class="hljs-string">'geometry'</span>].apply(calculate_area)
</div></code></pre>
<h3 id="step-7-group-results-by-grid-id-and-aggregate">Step 7: Group Results by Grid ID and Aggregate</h3>
<ul>
<li>Group the intersections by grid ID, summing the area and counting the number of unique counties in each grid.</li>
</ul>
<pre class="hljs"><code><div>result = intersections.groupby(<span class="hljs-string">'id'</span>).apply(<span class="hljs-keyword">lambda</span> x: pd.Series({
    <span class="hljs-string">'num_of_district'</span>: x[<span class="hljs-string">'CityName'</span>].nunique(),
    <span class="hljs-string">'area'</span>: x[<span class="hljs-string">'area'</span>].sum(),
    <span class="hljs-string">'geometry'</span>: x[<span class="hljs-string">'geometry'</span>].unary_union
})).reset_index()
</div></code></pre>
<h3 id="step-8-export-the-result-to-geojson-format">Step 8: Export the Result to GeoJSON Format</h3>
<ul>
<li>Set the CRS of the result to <code>EPSG:4326</code> and save it as a <code>GeoJSON</code> file.</li>
</ul>
<pre class="hljs"><code><div>result.set_crs(epsg=<span class="hljs-number">4326</span>, inplace=<span class="hljs-literal">True</span>)
result.to_file(<span class="hljs-string">'output.geojson'</span>, driver=<span class="hljs-string">'GeoJSON'</span>)
</div></code></pre>
<h1 id="overpass">overpass</h1>
<h2 id="taipei-mrt">Taipei MRT</h2>
<ul>
<li>The result include datas on new Taipei and Taoyuan</li>
</ul>
<pre class="hljs"><code><div>[out:json][timeout:25];
{{geocodeArea:Taipei}}-&gt;.searchArea;
(
  way[route=subway](area.searchArea);
  relation[route=subway](area.searchArea);
);
out body;
&gt;;
out skel qt;
</div></code></pre>
<pre class="hljs"><code><div>out body;
輸出查詢結果的詳細信息。這個指令會顯示所有查詢到的元素的具體數據。

&gt;;
表示查詢所有與結果相關的下層元素。通常用於獲取與路徑和關係相關的節點（node）。

out skel qt;
輸出結果的骨架信息（skeleton）。這樣可以獲取關於節點和路徑的結構化數據，便於後續處理和渲染。

</div></code></pre>
<p><img src="./image-6.png" alt="alt text"></p>
<h2 id="taipei--taichung-mrt">Taipei + Taichung MRT</h2>
<ul>
<li>search two region in the same time</li>
</ul>
<pre class="hljs"><code><div>[out:json][timeout:55];
// Fetch areas "Taipei" and "Taichung" to search in
{{geocodeArea:Taipei}}-&gt;.taipeiArea;
{{geocodeArea:Taichung}}-&gt;.taichungArea;

// Gather results from both areas
(
  way[route=subway](area.taipeiArea);
  way[route=subway](area.taichungArea);
  relation[route=subway](area.taipeiArea);
  relation[route=subway](area.taichungArea);
);

// Print results
out body;
&gt;;
out skel qt;
</div></code></pre>
<p><img src="./image-8.png" alt="alt text"></p>
<h2 id="taipei-mrt-above-ground-parts">Taipei MRT Above ground parts</h2>
<p>???</p>
<ul>
<li>只有way有layer屬性，realation &amp; node 都沒有
<img src="./image-17.png" alt="alt text"></li>
</ul>
<h2 id="singapore-water">singapore water</h2>
<pre class="hljs"><code><div>[out:json][timeout:25];
// Fetch the area of Singapore
{{geocodeArea:Singapore}}-&gt;.searchArea;

// Gather results for water bodies within Singapore
(
  way[natural=water](area.searchArea);
  relation[natural=water](area.searchArea);
);

// Print results
out body;
&gt;;
out skel qt;
</div></code></pre>
<p><img src="./image-16.png" alt="alt text"></p>

</body>
</html>
